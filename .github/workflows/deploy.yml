name: Simulasi CI/CD Pipeline - Enhanced

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Tambahkan trigger manual dari GitHub UI

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install dependencies
      run: |
        echo "ðŸ”§ Menginstal dependensi Python"
        pip install -r requirements.txt

    - name: Jalankan aplikasi dan simulasi akses
      run: |
        echo "ðŸš€ Menjalankan aplikasi dan menguji endpoint"
        python main.py &  # jalankan background
        sleep 3           # tunggu server siap
        RESPONSE=$(curl -s http://localhost:5000 || echo "Gagal mengakses endpoint")
        echo "ðŸ“¦ Hasil respons dari API: $RESPONSE"

    - name: Simulasi sukses
      if: success()
      run: echo "âœ… CI/CD berhasil disimulasikan tanpa deploy ke cloud."

    - name: Clean up proses Flask
      run: |
        echo "ðŸ§¹ Membersihkan proses Flask (jika masih jalan)"
        pkill -f "python main.py" || echo "Tidak ada proses ditemukan"
